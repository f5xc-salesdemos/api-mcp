name: OpenAPI Sync & Regenerate

on:
  schedule:
    # Run every 6 hours to check for upstream API changes
    - cron: "0 */6 * * *"
  repository_dispatch:
    # Triggered by webhook from robinmordasiewicz/f5xc-api-enriched releases
    types: [enriched-specs-updated]
  workflow_dispatch:
    inputs:
      force_regenerate:
        description: "Force regeneration even if no spec changes"
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sync-and-regenerate:
    name: Sync OpenAPI Specifications & Regenerate Tools
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Close existing openapi-sync PRs
        run: |
          # Close any existing openapi-sync PRs to prevent accumulation
          EXISTING_PRS=$(gh pr list --state open --head "openapi-sync/" --json number --jq '.[].number' || true)
          for PR in $EXISTING_PRS; do
            echo "Closing existing PR #$PR"
            gh pr close "$PR" --comment "Superseded by newer OpenAPI sync" || true
          done
        env:
          GH_TOKEN: ${{ secrets.REPO_ADMIN_TOKEN }}

      - name: Download OpenAPI specs from enriched source
        run: npm run sync-specs
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_ADMIN_TOKEN }}

      - name: Get version info
        id: version
        run: |
          if [[ -f specs/index.json ]]; then
            VERSION=$(jq -r '.version // "unknown"' specs/index.json)
            DOMAIN_COUNT=$(jq -r '.domains | length // 0' specs/index.json)
            TOOL_COUNT=$(jq -r '.toolCount // 0' specs/index.json)
            {
              echo "version=$VERSION"
              echo "domain_count=$DOMAIN_COUNT"
              echo "tool_count=$TOOL_COUNT"
            } >> "$GITHUB_OUTPUT"
          else
            {
              echo "version=unknown"
              echo "domain_count=0"
              echo "tool_count=0"
            } >> "$GITHUB_OUTPUT"
          fi

      - name: Generate tools from specs
        run: npm run generate

      - name: Generate test fixtures
        run: npm run generate:fixtures

      - name: Check for changes in generated code
        id: changes
        run: |
          if [[ -n $(git status src/tools/ tests/fixtures/ --porcelain) ]]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Generated code has changed"
            git status src/tools/ tests/fixtures/ --porcelain
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No changes to generated code"
          fi

      - name: Fix formatting
        if: steps.changes.outputs.changed == 'true' || github.event.inputs.force_regenerate == 'true'
        run: npm run lint:fix || true

      - name: TypeCheck
        if: steps.changes.outputs.changed == 'true' || github.event.inputs.force_regenerate == 'true'
        run: npm run typecheck

      - name: Run tests
        if: steps.changes.outputs.changed == 'true' || github.event.inputs.force_regenerate == 'true'
        run: npm test

      - name: Build
        if: steps.changes.outputs.changed == 'true' || github.event.inputs.force_regenerate == 'true'
        run: npm run build

      - name: Get regeneration stats
        id: stats
        if: steps.changes.outputs.changed == 'true' || github.event.inputs.force_regenerate == 'true'
        run: |
          # Extract stats from generated fixtures
          if [[ -f tests/fixtures/generated.ts ]]; then
            TOTAL_TOOLS=$(grep -o 'totalTools: [0-9]*' tests/fixtures/generated.ts | grep -o '[0-9]*' || echo "0")
            TOTAL_DOMAINS=$(grep -o 'totalDomains: [0-9]*' tests/fixtures/generated.ts | grep -o '[0-9]*' || echo "0")
            {
              echo "total_tools=$TOTAL_TOOLS"
              echo "total_domains=$TOTAL_DOMAINS"
            } >> "$GITHUB_OUTPUT"
          else
            {
              echo "total_tools=0"
              echo "total_domains=0"
            } >> "$GITHUB_OUTPUT"
          fi

      - name: Create Pull Request
        id: create-pr
        if: steps.changes.outputs.changed == 'true' || github.event.inputs.force_regenerate == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.REPO_ADMIN_TOKEN }}
          add-paths: |
            src/tools/
            tests/fixtures/
          commit-message: "feat(specs): update to v${{ steps.version.outputs.version }}"
          title: "feat(specs): Update OpenAPI specs to v${{ steps.version.outputs.version }}"
          body: |
            ## OpenAPI Specification Update

            **New Version**: v${{ steps.version.outputs.version }}

            ### Source
            - Repository: [robinmordasiewicz/f5xc-api-enriched](https://github.com/robinmordasiewicz/f5xc-api-enriched)

            ### Statistics
            - **Total Tools**: ${{ steps.stats.outputs.total_tools }}
            - **Total Domains**: ${{ steps.stats.outputs.total_domains }}

            ### Changes
            - Downloaded latest enriched specs from upstream (dynamically, not stored in git)
            - Regenerated MCP tools from new specs
            - Regenerated dynamic test fixtures
            - All tests passing

            ### Validation
            - [x] TypeScript compilation
            - [x] Unit tests passing
            - [x] Lint checks passing
            - [x] Build successful

            ---
            ðŸ¤– Generated automatically by OpenAPI Sync workflow
          branch: openapi-sync/v${{ steps.version.outputs.version }}
          delete-branch: true
          labels: |
            automated
            openapi
            dependencies

      - name: Enable auto-merge
        if: steps.create-pr.outputs.pull-request-number
        run: |
          gh pr merge ${{ steps.create-pr.outputs.pull-request-number }} --auto --squash
        env:
          GH_TOKEN: ${{ secrets.REPO_ADMIN_TOKEN }}

      - name: Summary
        run: |
          {
            echo "## OpenAPI Sync Summary"
            echo ""
            if [[ "${{ steps.changes.outputs.changed }}" == "true" ]] || [[ "${{ github.event.inputs.force_regenerate }}" == "true" ]]; then
              echo "âœ… Specs updated and PR created"
              echo ""
              echo "### Version Information"
              echo "- **Version**: ${{ steps.version.outputs.version }}"
              echo "- **Total Tools**: ${{ steps.stats.outputs.total_tools }}"
              echo "- **Total Domains**: ${{ steps.stats.outputs.total_domains }}"
              echo ""
              echo "### Changed Files"
              echo '```'
              git status src/tools/ tests/fixtures/ --porcelain || true
              echo '```'
            else
              echo "â„¹ï¸ No changes detected in generated code (specs are up to date)"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
