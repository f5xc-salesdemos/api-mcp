name: Update f5xc-auth Dependency

on:
  repository_dispatch:
    types: [f5xc-auth-release]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  update-dependency:
    name: Update f5xc-auth to ${{ github.event.client_payload.version }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Update f5xc-auth dependency
        id: update
        run: |
          VERSION="${{ github.event.client_payload.version }}"
          echo "Updating @robinmordasiewicz/f5xc-auth to version $VERSION"

          # Update package.json with specific version
          npm install --save "@robinmordasiewicz/f5xc-auth@$VERSION"

          # Capture changes
          if git diff --quiet package.json package-lock.json; then
            echo "updated=false" >> "$GITHUB_OUTPUT"
            echo "No changes detected"
          else
            echo "updated=true" >> "$GITHUB_OUTPUT"
            echo "Changes detected"
          fi

      - name: Run tests
        if: steps.update.outputs.updated == 'true'
        run: |
          npm ci
          npm test

      - name: Build
        if: steps.update.outputs.updated == 'true'
        run: npm run build

      - name: Create Pull Request
        if: steps.update.outputs.updated == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.REPO_ADMIN_TOKEN }}
          commit-message: |
            chore(deps): update f5xc-auth to ${{ github.event.client_payload.version }}

            Automated dependency update triggered by upstream release.

            Source: ${{ github.event.client_payload.repository }}@${{ github.event.client_payload.version }}

            ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

            Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
          branch: deps/f5xc-auth-${{ github.event.client_payload.version }}
          delete-branch: true
          title: "chore(deps): update f5xc-auth to ${{ github.event.client_payload.version }}"
          body: |
            ## Automated Dependency Update

            Updates `@robinmordasiewicz/f5xc-auth` from `^1.0.1` to `^${{ github.event.client_payload.version }}`

            **Source:** ${{ github.event.client_payload.repository }}@${{ github.event.client_payload.version }}

            ### Changes
            - Updated `package.json`
            - Updated `package-lock.json`

            ### Testing
            - [x] Tests passed
            - [x] Build succeeded

            ### Next Steps
            Once merged, the existing `release.yml` workflow will:
            1. Run full test suite
            2. Build with updated version
            3. Create GitHub release
            4. Publish to npm
            5. Build and push Docker images
            6. Create MCPB bundle

            ---
            ü§ñ Auto-generated by upstream f5xc-auth release
          labels: |
            dependencies
            automated

      - name: Summary
        run: |
          if [ "${{ steps.update.outputs.updated }}" == "true" ]; then
            echo "‚úÖ Created PR to update f5xc-auth to ${{ github.event.client_payload.version }}"
          else
            echo "‚ÑπÔ∏è No update needed - already at version ${{ github.event.client_payload.version }}"
          fi
